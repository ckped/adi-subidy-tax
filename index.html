<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç”¢å‰µè£œåŠ©ï¼†ç§Ÿç¨…å„ªæƒ è³‡æ–™ä¸Šå‚³èˆ‡æŸ¥è©¢å¹³å°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (XLSX) for Excel è™•ç† -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="min-h-screen max-w-6xl mx-auto p-4 space-y-6">
    <!-- Header -->
    <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold">ç”¢å‰µè£œåŠ©è³‡æ–™ä¸Šå‚³èˆ‡æŸ¥è©¢å¹³å°</h1>
        <p class="text-sm text-slate-600">
          ä¸€ç«™å¼ç”¢å‰µæ¢ä¾‹ç¨…å‹™å„ªæƒ ï¼‹è£œåŠ©è³‡è¨Šå…±äº«å¹³å°
        </p>
      </div>
      <div class="space-y-1 text-sm text-right">
        <div id="user-info" class="font-mono text-slate-700">è¼‰å…¥ä¸­...</div>
        <div class="text-xs text-slate-400">
          é–‹ç™¼ æ¨¡å¼å¯å¡« email æ¨¡æ“¬ï¼š<br />
          <input
            id="dev-email"
            type="email"
            placeholder="you@adi.gov.tw"
            class="mt-1 w-full rounded border border-slate-300 bg-white px-2 py-1 text-xs"
          />
        </div>
      </div>
    </header>

    <!-- Global message -->
    <div id="global-message" class="hidden rounded-md border px-3 py-2 text-sm"></div>

    <main class="space-y-10">
      <!-- Search Section -->
      <section id="search-section" class="rounded-xl bg-white p-4 shadow-sm">
        <div class="mb-4 flex items-center justify-between gap-2">
          <h2 class="text-lg font-semibold">ğŸ” å…¬å¸è³‡æ–™æŸ¥è©¢</h2>
          <div class="text-xs text-slate-500">
            çµ±ä¸€ç·¨è™Ÿï¼šç²¾æº–æŸ¥è©¢ Â· å…¬å¸åç¨±ï¼šæ¨¡ç³ŠæŸ¥è©¢
          </div>
        </div>

        <form id="search-form" class="flex flex-col gap-3 sm:flex-row sm:items-center">
          <input
            id="search-query"
            type="text"
            placeholder="è«‹è¼¸å…¥çµ±ä¸€ç·¨è™Ÿæˆ–å…¬å¸åç¨±"
            class="flex-1 rounded border border-slate-300 px-3 py-2 text-sm"
            required
          />
          <button
            type="submit"
            class="rounded bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700"
          >
            æŸ¥è©¢
          </button>
          <button
            id="search-export-btn"
            type="button"
            class="rounded border border-blue-600 px-4 py-2 text-sm font-semibold text-blue-700 hover:bg-blue-50"
          >
            åŒ¯å‡ºæŸ¥è©¢çµæœï¼ˆCSVï¼‰
          </button>
        </form>

        <div id="search-result-meta" class="mt-4 text-xs text-slate-500"></div>

        <div id="search-results" class="mt-4 space-y-4"></div>
      </section>

      <!-- Upload Section -->
      <section id="upload-section" class="rounded-xl bg-white p-4 shadow-sm">
        <div class="mb-4 flex items-center justify-between gap-2">
          <h2 class="text-lg font-semibold">ğŸ“¤ ä¸Šå‚³è³‡æ–™ï¼ˆCSVæˆ–Excelï¼‰</h2>
          <div class="text-xs text-slate-500">
            æ¬„ä½åç¨±å¯ç”¨ä¸­æ–‡ï¼Œè‡³å°‘éœ€åŒ…å«ã€Œçµ±ä¸€ç·¨è™Ÿã€ã€ã€Œå…¬å¸åç¨±ã€
          </div>
        </div>

        <form id="upload-form" class="space-y-4">
          <div class="grid gap-3 sm:grid-cols-3">
            <div class="sm:col-span-2">
              <label class="block text-xs font-medium text-slate-700 mb-1">
                æœå‹™é …ç›®
              </label>
              <select
                id="upload-service-select"
                class="w-full rounded border border-slate-300 px-3 py-2 text-sm bg-white"
              >
              </select>
              <p class="mt-1 text-xs text-slate-400">
                å¯é¸æ“‡å°æ‡‰çš„æœå‹™é …ç›®ä¸Šå‚³è³‡æ–™ï¼Œå¦‚ç„¡å°æ‡‰çš„æœå‹™é …ç›®å¯æ–¼ä¸‹æ–¹æ–°å¢æœå‹™é …ç›®
              </p>
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1">
                æ¨™é ­åˆ—åˆ—è™Ÿï¼ˆå“ªä¸€åˆ—æ˜¯æ¬„ä½åç¨±ï¼Ÿï¼‰
              </label>
              <input
                id="header-row"
                type="number"
                min="1"
                value="2"
                class="w-full rounded border border-slate-300 px-3 py-2 text-sm"
              />
              <p class="mt-1 text-xs text-slate-400">é è¨­ç¬¬ 2 åˆ—ç‚ºæ¬„ä½åç¨±</p>
            </div>
          </div>

          <div class="grid gap-3 sm:grid-cols-2">
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1">
                çµ±ä¸€ç·¨è™Ÿæ¬„ä½åç¨±ï¼ˆå¦‚ã€Œçµ±ç·¨ã€ã€ã€Œå…¬å¸çµ±ç·¨ã€ï¼Œè«‹å¯«å‡ºä½ çš„æª”æ¡ˆä¸Šå°æ‡‰çš„æ¬„ä½åç¨±ï¼‰
              </label>
              <input
                id="company-id-header"
                type="text"
                value="çµ±ä¸€ç·¨è™Ÿ"
                class="w-full rounded border border-slate-300 px-3 py-2 text-sm"
              />
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1">
                å…¬å¸åç¨±æ¬„ä½åç¨±
              </label>
              <input
                id="company-name-header"
                type="text"
                value="å…¬å¸åç¨±"
                class="w-full rounded border border-slate-300 px-3 py-2 text-sm"
              />
            </div>
          </div>

          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">
              ä¸Šå‚³ CSV/Excel æª”æ¡ˆ
            </label>
            <input
              id="csv-file"
              type="file"
              accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.xlsx"
              class="block w-full text-sm"
            />
            <p class="mt-1 text-xs text-slate-400">
              æ”¯æ´ CSV / Excelï¼ˆ.xlsxï¼‰ã€‚è‹¥ç‚º Excelï¼Œç³»çµ±æœƒè‡ªå‹•è½‰ç‚º CSV å†åŒ¯å…¥ï¼Œå› æ­¤è«‹ä¸è¦åˆä½µå„²å­˜æ ¼
            </p>
          </div>

          <div class="flex justify-end gap-3">
            <button
              type="submit"
              class="rounded bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700"
            >
              ä¸Šå‚³ä¸¦åŒ¯å…¥è³‡æ–™åº«
            </button>
          </div>
        </form>
      </section>

      <!-- Manage Section -->
      <section id="manage-section" class="rounded-xl bg-white p-4 shadow-sm">
        <div class="mb-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <h2 class="text-lg font-semibold">âš™ï¸ æœå‹™é …ç›®ç®¡ç†ï¼ˆæ“æœ‰è€…ä½¿ç”¨ï¼‰</h2>
          <div class="text-xs text-slate-500">
            åªå…è¨± æ“æœ‰è€… åˆªé™¤ / è½‰ç§» æœå‹™é …ç›®
          </div>
        </div>

        <div class="grid gap-4 sm:grid-cols-3">
          <div class="sm:col-span-2 space-y-3">
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1">
                é¸æ“‡æœå‹™é …ç›®
              </label>
              <select
                id="manage-service-select"
                class="w-full rounded border border-slate-300 px-3 py-2 text-sm bg-white"
              ></select>
            </div>

            <div>
              <h3 class="text-sm font-medium text-slate-700 mb-2">ä¸Šå‚³æ­·å²ç´€éŒ„</h3>
              <div id="uploads-list" class="space-y-2 text-xs"></div>
            </div>
          </div>
        <div class="space-y-3">
          <!-- æ–°å¢ï¼šæ–°å¢æœå‹™é …ç›® -->
          <div class="rounded border border-slate-200 p-3">
            <h3 class="text-sm font-semibold text-slate-700">æ–°å¢æœå‹™é …ç›®</h3>
            <p class="mt-1 text-xs text-slate-500">
              ä¸€èˆ¬ç™»å…¥ä½¿ç”¨è€…å‡å¯æ–°å¢ï¼Œæ–°å¢è€…å°‡æˆç‚ºè©²æœå‹™çš„æ“æœ‰è€…ï¼ˆå¯ç§»è½‰ï¼‰ã€‚
            </p>
            <form id="create-service-form" class="mt-2 space-y-2 text-xs">
              <label class="block">
                æœå‹™åç¨±
                <input
                  id="new-service-name"
                  type="text"
                  class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-xs"
                  placeholder="ä¾‹å¦‚ï¼šç ”ç™¼æŠ•è³‡æŠµæ¸›"
                  required
                />
              </label>
              <label class="block">
                æœå‹™èªªæ˜ï¼ˆå¯é¸ï¼‰
                <textarea
                  id="new-service-description"
                  rows="2"
                  class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-xs"
                  placeholder="ç°¡è¦èªªæ˜é€™å€‹æœå‹™é …ç›®ï¼Œä¾‹å¦‚ï¼šä¼æ¥­å…·é«˜åº¦ä¹‹å‰µæ–°çš„ç ”ç™¼è¨ˆç•«ï¼Œå¯äº«æœ‰ç‡Ÿæ¥­æ‰€å¾—ç¨…ç•¶å¹´15%ã€ä¸‰å¹´å…§10%ä¹‹æŠµæ¸›ã€‚"
                ></textarea>
              </label>
              <button
                type="submit"
                class="mt-1 w-full rounded bg-blue-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-blue-700"
              >
                å»ºç«‹æœå‹™é …ç›®
              </button>
            </form>
          </div>
          <div class="space-y-3">
            <div class="rounded border border-slate-200 p-3">
              <h3 class="text-sm font-semibold text-slate-700">è½‰ç§»æœå‹™é …ç›®è² è²¬äºº</h3>
              <p class="mt-1 text-xs text-slate-500">
                åƒ…é™ç¾ä»»æ“æœ‰è€…å¯ä»¥åŸ·è¡Œã€‚
              </p>
              <form id="transfer-owner-form" class="mt-2 space-y-2 text-xs">
                <label class="block">
                  æ–°æ“æœ‰è€…email
                  <input
                    id="new-owner-email"
                    type="email"
                    class="mt-1 w-full rounded border border-slate-300 px-2 py-1 text-xs"
                    placeholder="new-owner@adi.gov.tw"
                  />
                </label>
                <button
                  type="submit"
                  class="mt-1 w-full rounded bg-amber-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-amber-700"
                >
                  è½‰ç§»è² è²¬äºº
                </button>
              </form>
              <hr class="my-3 border-slate-200" />
              <button
                id="delete-service-btn"
                type="button"
                class="w-full rounded bg-red-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-red-700"
              >
                åˆªé™¤æ­¤æœå‹™é …ç›®ï¼ˆåƒ…é™æ“æœ‰è€…/ç®¡ç†è€…ï¼‰
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // =========================
    // åŸºæœ¬è¨­å®š
    // =========================

    // Pages Functions èˆ‡å‰ç«¯åŒç¶²åŸŸï¼Œå› æ­¤ç›´æ¥èµ°ç›¸å°è·¯å¾‘ï¼Œä¸å†è·¨ç¶²åŸŸ
    const API_BASE = ""; // => /api/xxx

    let currentUser = null;
    let services = [];

    const userInfoEl = document.getElementById("user-info");
    const globalMessageEl = document.getElementById("global-message");
    const devEmailInput = document.getElementById("dev-email");

    function showMessage(text, type = "info") {
      if (!text) {
        globalMessageEl.classList.add("hidden");
        return;
      }
      globalMessageEl.textContent = text;
      globalMessageEl.classList.remove("hidden");
      globalMessageEl.classList.remove(
        "border-blue-200",
        "bg-blue-50",
        "text-blue-800",
        "border-red-200",
        "bg-red-50",
        "text-red-800",
        "border-emerald-200",
        "bg-emerald-50",
        "text-emerald-800"
      );
      if (type === "error") {
        globalMessageEl.classList.add(
          "border-red-200",
          "bg-red-50",
          "text-red-800"
        );
      } else if (type === "success") {
        globalMessageEl.classList.add(
          "border-emerald-200",
          "bg-emerald-50",
          "text-emerald-800"
        );
      } else {
        globalMessageEl.classList.add(
          "border-blue-200",
          "bg-blue-50",
          "text-blue-800"
        );
      }
    }

    /**
     * çµ±ä¸€å‘¼å«å¾Œç«¯ API çš„ helper
     * - æœƒè‡ªå‹•å¸¶ä¸Š dev emailï¼ˆX-User-Emailï¼‰
     * - å°æ­£å¼ç’°å¢ƒï¼ŒAccess æœƒç”¨ Cookieï¼Œæ†‘è­‰èµ°åŒç¶²åŸŸ
     */
    async function apiFetch(path, options = {}) {
      let { method = "GET", headers = {}, body } = options;

      const finalHeaders = { ...headers };

      // å¦‚æœæœ‰ body è€Œä¸”ä¸æ˜¯ FormDataï¼Œå°±è‡ªå‹•è½‰æˆ JSON
      if (body && !(body instanceof FormData)) {
        finalHeaders["Content-Type"] = "application/json";
        if (typeof body !== "string") {
          body = JSON.stringify(body);
        }
      }

      // dev æ¨¡å¼ï¼šå¦‚æœç•«é¢ä¸Šæœ‰è¼¸å…¥æ¸¬è©¦ emailï¼Œå°±å¡ X-User-Email
      const devEmail = devEmailInput?.value.trim();
      if (devEmail) {
        finalHeaders["X-User-Email"] = devEmail;
      }

      const res = await fetch(API_BASE + path, {
        method,
        headers: finalHeaders,
        body,
        credentials: "include", // çµ¦ Access cookie ç”¨
      });

      return res;
    }

    // =========================
    // 1. è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š / æœå‹™æ¸…å–®
    // =========================

    async function loadMe() {
      try {
        const res = await apiFetch("/api/me", { method: "GET" });
        if (!res.ok) {
          userInfoEl.textContent = "æœªç™»å…¥";
          return;
        }
        const data = await res.json();
        if (data.authenticated) {
          currentUser = data.user;
          userInfoEl.textContent =
            "ä½¿ç”¨è€…ï¼š" + currentUser.email + " Â· å»ºç«‹æ–¼ " + currentUser.created_at;
          if (!devEmailInput.value.trim()) {
            devEmailInput.value = currentUser.email;
          }
        } else {
          userInfoEl.textContent = "æœªé©—è­‰";
        }
      } catch (err) {
        console.error(err);
        userInfoEl.textContent = "è¼‰å…¥APIæ™‚ç™¼ç”ŸéŒ¯èª¤";
      }
    }

    async function loadServices() {
      try {
        const res = await apiFetch("/api/services", { method: "GET" });
        if (!res.ok) {
          showMessage("è®€å–æœå‹™é …ç›®å¤±æ•—", "error");
          return;
        }
        services = await res.json();
        renderServiceSelects();
      } catch (err) {
        console.error(err);
        showMessage("å‘¼å« /api/services ç™¼ç”ŸéŒ¯èª¤", "error");
      }
    }

    function renderServiceSelects() {
      const uploadSelect = document.getElementById("upload-service-select");
      const manageSelect = document.getElementById("manage-service-select");

      uploadSelect.innerHTML = "";
      manageSelect.innerHTML = "";

      if (!services.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "å°šç„¡æœå‹™é …ç›®ï¼Œè«‹å…ˆé€é API å»ºç«‹";
        uploadSelect.appendChild(opt);
        manageSelect.appendChild(opt.cloneNode(true));
        return;
      }

      for (const s of services) {
        const opt1 = document.createElement("option");
        opt1.value = s.id;
        opt1.textContent = `${s.id} - ${s.name}`;
        uploadSelect.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = s.id;
        opt2.textContent = `${s.id} - ${s.name}`;
        manageSelect.appendChild(opt2);
      }
    }

    // =========================
    // 2. æŸ¥è©¢èˆ‡åŒ¯å‡º
    // =========================

    async function handleSearch(event) {
      event.preventDefault();
      const q = document.getElementById("search-query").value.trim();
      if (!q) return;

      showMessage("æŸ¥è©¢ä¸­...", "info");

      try {
        const res = await apiFetch("/api/search?q=" + encodeURIComponent(q), {
          method: "GET",
          headers: {},
        });
        if (!res.ok) {
          showMessage("æŸ¥è©¢å¤±æ•—ï¼ˆ" + res.status + "ï¼‰", "error");
          return;
        }
        const data = await res.json();
        showMessage("æŸ¥è©¢å®Œæˆï¼Œå…± " + data.count + " ç­†ã€‚", "success");
        renderSearchResults(data);
      } catch (err) {
        console.error(err);
        showMessage("æŸ¥è©¢ API ç™¼ç”ŸéŒ¯èª¤", "error");
      }
    }

    function renderSearchResults(data) {
      const metaEl = document.getElementById("search-result-meta");
      const resultsEl = document.getElementById("search-results");
      resultsEl.innerHTML = "";

      metaEl.textContent =
        "æŸ¥è©¢å­—ä¸²ï¼šã€Œ" +
        data.query +
        "ã€ï¼Œ" +
        (data.is_company_id ? "ä»¥çµ±ä¸€ç·¨è™Ÿç²¾æº–æŸ¥è©¢" : "ä»¥å…¬å¸åç¨±æ¨¡ç³ŠæŸ¥è©¢") +
        "ã€‚å…± " +
        data.count +
        " ç­†çµæœã€‚";

      if (!data.results || !data.results.length) {
        resultsEl.innerHTML =
          '<div class="text-sm text-slate-500">æ²’æœ‰ç¬¦åˆçš„çµæœã€‚</div>';
        return;
      }

      const groupByService = {};
      for (const r of data.results) {
        if (!groupByService[r.service_id]) {
          groupByService[r.service_id] = {
            service_name: r.service_name,
            items: [],
          };
        }
        groupByService[r.service_id].items.push(r);
      }

      for (const [serviceId, group] of Object.entries(groupByService)) {
        const card = document.createElement("div");
        card.className = "rounded-lg border border-slate-200 bg-slate-50 p-3";

        const header = document.createElement("div");
        header.className =
          "flex flex-col gap-1 border-b border-slate-200 pb-2 mb-2 text-sm";
        header.innerHTML = `
          <div class="font-semibold">${group.service_name}ï¼ˆID: ${serviceId}ï¼‰</div>
          <div class="text-xs text-slate-500">
            æœ¬æœå‹™å…±æœ‰ ${group.items.length} ç­†ç¬¦åˆ
          </div>
        `;
        card.appendChild(header);

        const list = document.createElement("div");
        list.className = "space-y-2 text-xs";

        for (const item of group.items) {
          const rowDiv = document.createElement("div");
          rowDiv.className = "rounded border border-slate-200 bg-white p-2";

          const metaRow = document.createElement("div");
          metaRow.className =
            "mb-1 flex flex-wrap items-center justify-between gap-1";
          metaRow.innerHTML = `
            <div>
              <span class="text-slate-500">ä¸Šå‚³è€…ï¼š</span>
              <span class="font-mono">${item.uploaded_by_email}</span>
            </div>
            <div class="text-slate-500">
              ä¸Šå‚³æ™‚é–“ï¼š${item.uploaded_at}
            </div>
          `;
          rowDiv.appendChild(metaRow);

          const table = document.createElement("table");
          table.className = "w-full border-collapse text-xs";
          const tbody = document.createElement("tbody");

          const row = item.row;
          for (const [key, value] of Object.entries(row)) {
            const tr = document.createElement("tr");
            tr.className = "border-t border-slate-100";
            tr.innerHTML = `
              <td class="w-32 px-1 py-0.5 text-slate-500">${key}</td>
              <td class="px-1 py-0.5 font-mono">${value ?? ""}</td>
            `;
            tbody.appendChild(tr);
          }
          table.appendChild(tbody);
          rowDiv.appendChild(table);

          list.appendChild(rowDiv);
        }

        card.appendChild(list);
        resultsEl.appendChild(card);
      }
    }

    function handleExport() {
      const q = document.getElementById("search-query").value.trim();
      if (!q) {
        showMessage("è«‹å…ˆè¼¸å…¥æŸ¥è©¢å­—ä¸²å†åŒ¯å‡ºã€‚", "error");
        return;
      }
      const url = API_BASE + "/api/search/export?q=" + encodeURIComponent(q);
      window.location.href = url;
    }

    // =========================
    // 3. ä¸Šå‚³ CSV
    // =========================

    async function handleUpload(event) {
      event.preventDefault();
    
      const serviceSelect = document.getElementById("upload-service-select");
      const serviceId = serviceSelect.value;
      if (!serviceId) {
        showMessage("è«‹å…ˆé¸æ“‡æœå‹™é …ç›®ã€‚", "error");
        return;
      }
    
      const fileInput = document.getElementById("csv-file");
      if (!fileInput.files || !fileInput.files.length) {
        showMessage("è«‹é¸æ“‡ä¸€å€‹ CSV æˆ– Excel æª”æ¡ˆã€‚", "error");
        return;
      }
    
      const headerRow = parseInt(
        document.getElementById("header-row").value || "2",
        10
      );
      const companyIdHeader =
        document.getElementById("company-id-header").value.trim() || "çµ±ä¸€ç·¨è™Ÿ";
      const companyNameHeader =
        document.getElementById("company-name-header").value.trim() || "å…¬å¸åç¨±";
    
      const file = fileInput.files[0];
      const filename = file.name;
    
      showMessage("è®€å–æª”æ¡ˆä¸¦ä¸Šå‚³ä¸­...", "info");
    
      try {
        let text;
    
        // æª”ååˆ¤æ–·æ˜¯å¦ç‚º .xlsx
        const lowerName = filename.toLowerCase();
        if (lowerName.endsWith(".xlsx")) {
          // ç”¨ SheetJS è®€ Excel -> å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨ -> è½‰ CSV å­—ä¸²
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
    
          // é€™è£¡æœƒè¼¸å‡ºæ¨™æº– CSVï¼Œä¸Ÿçµ¦å¾Œç«¯å°±è·ŸåŸæœ¬ä¸€æ¨£
          text = XLSX.utils.sheet_to_csv(worksheet);
        } else {
          // åŸæœ¬å°±æ”¯æ´çš„ CSV è·¯å¾‘
          text = await file.text();
        }
    
        const body = {
          filename,
          header_row: headerRow,
          company_id_header: companyIdHeader,
          company_name_header: companyNameHeader,
          data: text,
        };
    
        const res = await apiFetch(
          `/api/services/${encodeURIComponent(serviceId)}/upload`,
          {
            method: "POST",
            body: JSON.stringify(body),
          }
        );
    
        if (!res.ok) {
          const errText = await res.text();
          console.error("Upload error:", errText);
          showMessage("ä¸Šå‚³å¤±æ•—ï¼š" + errText, "error");
          return;
        }
    
        const dataResp = await res.json();
        showMessage(
          `ä¸Šå‚³æˆåŠŸï¼šæœå‹™ ${dataResp.service_id} Â· åŒ¯å…¥ ${dataResp.inserted_rows} ç­†ã€‚`,
          "success"
        );
    
        fileInput.value = "";
    
        const manageSelect = document.getElementById("manage-service-select");
        if (manageSelect.value === String(serviceId)) {
          await loadUploadsForService(serviceId);
        }
      } catch (err) {
        console.error(err);
        showMessage("ä¸Šå‚³æµç¨‹ç™¼ç”ŸéŒ¯èª¤", "error");
      }
    }


    // =========================
    // 4. ç®¡ç†ï¼šåˆ—å‡ºä¸Šå‚³ç´€éŒ„ / è»Ÿåˆªé™¤ / è½‰ç§» owner
    // =========================

    async function loadUploadsForService(serviceId) {
      if (!serviceId) return;
      const listEl = document.getElementById("uploads-list");
      listEl.innerHTML = "è¼‰å…¥ä¸­...";

      try {
        const res = await apiFetch(
          `/api/services/${encodeURIComponent(serviceId)}/uploads`,
          {
            method: "GET",
            headers: {},
          }
        );
        if (!res.ok) {
          const txt = await res.text();
          listEl.innerHTML =
            '<div class="text-red-600 text-xs">è®€å–ä¸Šå‚³ç´€éŒ„å¤±æ•—ï¼š' +
            txt +
            "</div>";
          return;
        }
        const data = await res.json();
        renderUploadsList(serviceId, data);
      } catch (err) {
        console.error(err);
        listEl.innerHTML =
          '<div class="text-red-600 text-xs">å‘¼å« uploads API ç™¼ç”ŸéŒ¯èª¤</div>';
      }
    }

    function renderUploadsList(serviceId, uploads) {
      const listEl = document.getElementById("uploads-list");
      listEl.innerHTML = "";

      if (!uploads.length) {
        listEl.innerHTML =
          '<div class="text-xs text-slate-500">å°šç„¡ä¸Šå‚³ç´€éŒ„ã€‚</div>';
        return;
      }

      for (const u of uploads) {
        const card = document.createElement("div");
        card.className = "rounded border border-slate-200 bg-slate-50 p-2";

        card.innerHTML = `
          <div class="flex items-center justify-between gap-2 mb-1">
            <div class="text-xs font-semibold">
              #${u.id} Â· ${u.original_filename || "(æœªå‘½å)"}
            </div>
            <div class="text-[11px] px-2 py-0.5 rounded-full ${
              u.status === "active"
                ? "bg-emerald-100 text-emerald-800"
                : "bg-slate-200 text-slate-700"
            }">
              ${u.status}
            </div>
          </div>
          <div class="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[11px] text-slate-600">
            <div>ä¸Šå‚³è€…ï¼š<span class="font-mono">${
              u.uploaded_by_email
            }</span></div>
            <div>ä¸Šå‚³æ™‚é–“ï¼š${u.uploaded_at}</div>
            <div>ç­†æ•¸ï¼š${u.row_count ?? "?"}</div>
            <div>header_rowï¼š${u.header_row_index}</div>
            <div>çµ±ä¸€ç·¨è™Ÿæ¬„ä½ï¼š${u.company_id_header || "çµ±ä¸€ç·¨è™Ÿ"}</div>
            <div>å…¬å¸åç¨±æ¬„ä½ï¼š${u.company_name_header || "å…¬å¸åç¨±"}</div>
            <div>åˆªé™¤æ™‚é–“ï¼š${u.deleted_at || "-"}</div>
          </div>
        `;

        if (u.status === "active") {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.textContent = "æ¨™è¨˜ç‚º deletedï¼ˆè»Ÿåˆªé™¤ï¼‰";
          btn.className =
            "mt-2 inline-flex items-center rounded bg-red-600 px-2 py-1 text-[11px] font-semibold text-white hover:bg-red-700";
          btn.addEventListener("click", async () => {
            if (
              !confirm(
                `ç¢ºå®šè¦å°‡ä¸Šå‚³ #${u.id} æ¨™è¨˜ç‚º deleted å—ï¼Ÿï¼ˆä¸æœƒåˆªå¯¦é«”è³‡æ–™ï¼‰`
              )
            ) {
              return;
            }
            await deleteUpload(serviceId, u.id);
          });
          card.appendChild(btn);
        }

        listEl.appendChild(card);
      }
    }

    async function deleteUpload(serviceId, uploadId) {
      try {
        const res = await apiFetch(
          `/api/services/${encodeURIComponent(
            serviceId
          )}/uploads/${encodeURIComponent(uploadId)}/delete`,
          {
            method: "POST",
            body: JSON.stringify({}),
          }
        );
        if (!res.ok) {
          const txt = await res.text();
          showMessage("åˆªé™¤å¤±æ•—ï¼š" + txt, "error");
          return;
        }
        showMessage(`å·²å°‡ä¸Šå‚³ #${uploadId} æ¨™è¨˜ç‚º deletedã€‚`, "success");
        await loadUploadsForService(serviceId);
      } catch (err) {
        console.error(err);
        showMessage("åˆªé™¤ API ç™¼ç”ŸéŒ¯èª¤", "error");
      }
    }

    async function handleCreateService(event) {
      event.preventDefault();
    
      const nameInput = document.getElementById("new-service-name");
      const descInput = document.getElementById("new-service-description");
      const name = nameInput.value.trim();
      const description = descInput.value.trim();
    
      if (!name) {
        showMessage("è«‹è¼¸å…¥æœå‹™åç¨±ã€‚", "error");
        return;
      }
    
      showMessage("å»ºç«‹æœå‹™é …ç›®ä¸­...", "info");
    
      try {
        const res = await apiFetch("/api/services", {
          method: "POST",
          body: { name, description },
        });
    
        if (!res.ok) {
          const txt = await res.text();
          showMessage("å»ºç«‹æœå‹™é …ç›®å¤±æ•—ï¼š" + txt, "error");
          return;
        }
    
        const service = await res.json();
    
        showMessage(
          `å·²å»ºç«‹æœå‹™é …ç›®ï¼š#${service.id} ${service.name}ï¼ˆownerï¼š${service.owner_email}ï¼‰`,
          "success"
        );
    
        // æ¸…ç©ºè¡¨å–®
        nameInput.value = "";
        descInput.value = "";
    
        // é‡æ–°è¼‰å…¥æœå‹™æ¸…å–®ï¼Œè®“ä¸‹æ‹‰é¸å–®æœ‰æ–°æœå‹™
        await loadServices();
    
        // é †æ‰‹æŠŠã€Œç®¡ç†é¸å–®ã€åˆ‡åˆ°æ–°å»ºç«‹çš„æœå‹™ï¼Œä¸¦è¼‰å…¥å…¶ä¸Šå‚³ç´€éŒ„
        const manageSelect = document.getElementById("manage-service-select");
        manageSelect.value = String(service.id);
        await loadUploadsForService(service.id);
      } catch (err) {
        console.error(err);
        showMessage("å»ºç«‹æœå‹™é …ç›® API ç™¼ç”ŸéŒ¯èª¤", "error");
      }
    }

    async function handleDeleteCurrentService() {
      const serviceSelect = document.getElementById("manage-service-select");
      const serviceId = serviceSelect.value;
    
      if (!serviceId) {
        showMessage("è«‹å…ˆåœ¨å³å´ä¸‹æ‹‰é¸å–®é¸æ“‡è¦åˆªé™¤çš„æœå‹™é …ç›®ã€‚", "error");
        return;
      }
    
      const service = services.find((s) => String(s.id) === String(serviceId));
      const serviceName = service ? service.name : serviceId;
    
      if (
        !confirm(
          `ç¢ºå®šè¦åˆªé™¤æœå‹™é …ç›®ã€Œ${serviceName}ã€ï¼ˆID: ${serviceId}ï¼‰å—ï¼Ÿ\n` +
            "æ­¤å‹•ä½œæœƒåˆªé™¤ï¼š\n" +
            "1. è©²æœå‹™æ‰€æœ‰ä¸Šå‚³æª”æ¡ˆ" +
            "2. æ‰€æœ‰ä¸Šå‚³ç´€éŒ„\n" +
            "3. è©²æœå‹™é …ç›®\n\n" +
            "åƒ…é™ æ“æœ‰è€… æˆ–ç®¡ç†è€…å¯ä»¥åŸ·è¡Œã€‚"
        )
      ) {
        return;
      }
    
      try {
        const res = await apiFetch(
          `/api/services/${encodeURIComponent(serviceId)}/delete`,
          {
            method: "POST",
            body: {}, // å¾Œç«¯ä¸éœ€è¦å…§å®¹ï¼Œä½† fetch æœƒéœ€è¦ä¸€å€‹ body ç‰©ä»¶æ™‚å¯æ”¾ç©º
          }
        );
    
        if (!res.ok) {
          const txt = await res.text();
          showMessage("åˆªé™¤æœå‹™é …ç›®å¤±æ•—ï¼š" + txt, "error");
          return;
        }
    
        showMessage(
          `å·²åˆªé™¤æœå‹™é …ç›®ã€Œ${serviceName}ã€ï¼ˆID: ${serviceId}ï¼‰ã€‚`,
          "success"
        );
    
        // é‡æ–°è¼‰å…¥æœå‹™æ¸…å–®ï¼Œæ›´æ–°ä¸‹æ‹‰é¸å–®
        await loadServices();
    
        // æ¸…ç©ºä¸Šå‚³ç´€éŒ„å€å¡Š
        document.getElementById("uploads-list").innerHTML =
          '<div class="text-xs text-slate-500">è«‹é‡æ–°é¸æ“‡æœå‹™é …ç›®ã€‚</div>';
      } catch (err) {
        console.error(err);
        showMessage("åˆªé™¤æœå‹™é …ç›® API ç™¼ç”ŸéŒ¯èª¤", "error");
      }
    }

    

    async function handleTransferOwner(event) {
      event.preventDefault();
      const serviceSelect = document.getElementById("manage-service-select");
      const serviceId = serviceSelect.value;
      if (!serviceId) {
        showMessage("è«‹å…ˆé¸æ“‡æœå‹™é …ç›®ã€‚", "error");
        return;
      }
      const newOwner = document
        .getElementById("new-owner-email")
        .value.trim();
      if (!newOwner) {
        showMessage("è«‹è¼¸å…¥æ–° owner çš„ emailã€‚", "error");
        return;
      }

      if (
        !confirm(
          `ç¢ºå®šè¦æŠŠæœå‹™ ${serviceId} çš„ owner è½‰ç§»çµ¦ ${newOwner} å—ï¼Ÿ`
        )
      ) {
        return;
      }

      try {
        const res = await apiFetch(
          `/api/services/${encodeURIComponent(serviceId)}/transfer-owner`,
          {
            method: "POST",
            body: JSON.stringify({ new_owner_email: newOwner }),
          }
        );
        if (!res.ok) {
          const txt = await res.text();
          showMessage("è½‰ç§» owner å¤±æ•—ï¼š" + txt, "error");
          return;
        }
        showMessage(
          `æœå‹™ ${serviceId} çš„ owner å·²è½‰ç§»çµ¦ ${newOwner}ï¼ˆä»¥å¯¦éš›å¾Œç«¯ç‚ºæº–ï¼‰ã€‚`,
          "success"
        );
        document.getElementById("new-owner-email").value = "";
        await loadServices();
      } catch (err) {
        console.error(err);
        showMessage("transfer-owner API ç™¼ç”ŸéŒ¯èª¤", "error");
      }
    }

    // =========================
    // 5. åˆå§‹åŒ–
    // =========================

    document.addEventListener("DOMContentLoaded", async () => {
      document
        .getElementById("search-form")
        .addEventListener("submit", handleSearch);
      document
        .getElementById("search-export-btn")
        .addEventListener("click", handleExport);
      document
        .getElementById("upload-form")
        .addEventListener("submit", handleUpload);
      document
        .getElementById("manage-service-select")
        .addEventListener("change", (e) =>
          loadUploadsForService(e.target.value)
        );
      document
        .getElementById("transfer-owner-form")
        .addEventListener("submit", handleTransferOwner);
      document
        .getElementById("create-service-form")
        .addEventListener("submit", handleCreateService);
      document
        .getElementById("delete-service-btn")
        .addEventListener("click", handleDeleteCurrentService);

      await loadMe();
      await loadServices();

      const manageSelect = document.getElementById("manage-service-select");
      if (manageSelect.value) {
        await loadUploadsForService(manageSelect.value);
      }
    });
  </script>
</body>
</html>
